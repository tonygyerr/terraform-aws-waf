Creates a WAF and associates it with an Application Load Balancer (ALB)

Creates the following resources:

* Web Application Firewall (WAF)
* Links F5-managed OWASP rules for WAF to block common attacks
* Creates rule for WAF to block requests by source IP Address (**Note**: the list of blocked IPs are not managed by this module)
* Creates rule for WAF to block requests by path (as found in URI)
* Creates rule for WAF to allow requests by host (as found in HTTP Header)
* Attaches WAF to Application Load Balancer (ALB)

## Usage

```hcl
resource "aws_wafregional_rate_based_rule" "ipratelimit" {
  name        = "${var.app_name}-global-ip-rate-limit"
  metric_name = "wafAppGlobalIpRateLimit"
  rate_key    = "IP"
  rate_limit  = 2000
}

module "waf" {
  source = "git::https://github.com/tonygyerr/terraform-aws-waf.git"

  app_name              = var.app_name
  alb_arn               = data.aws_lb.this.arn
  associate_alb         = true
  aws_region            = var.aws_region
  environment           = var.environment
  profile               = var.profile
  blocked_path_prefixes = ["/admin", "/password"]
  allowed_hosts         = ["apples", "oranges"] 
  rate_based_rules      = [aws_wafregional_rate_based_rule.ipratelimit.id]
  web_acl_name          = "${var.app_name}-wacl"
  web_acl_metric_name   = "${var.app_name}-wacl-metric"
}
```

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 0.13.0 |
| aws | >= 3.0 |

## Providers

| Name | Version |
|------|---------|
| aws | >= 3.0 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| alb\_arn | ARN of the Application Load Balancer (ALB) to be associated with the Web Application Firewall (WAF) Access Control List (ACL). | `string` | n/a | yes |
| allowed\_hosts | The list of allowed host names as specified in HOST header. | `list(string)` | n/a | yes |
| associate\_alb | Whether to associate an Application Load Balancer (ALB) with an Web Application Firewall (WAF) Access Control List (ACL). | `bool` | `false` | no |
| blocked\_path\_prefixes | The list of URI path prefixes to block using the WAF. | `list(string)` | `[]` | no |
| ip\_sets | List of sets of IP addresses to block. | `list(string)` | `[]` | no |
| rate\_based\_rules | List of IDs of Rate-Based Rules to add to this WAF.  Only use this variable for rate-based rules.  Use the "rules" variable for regular rules. | `list(string)` | `[]` | no |
| rules | List of IDs of Rules to add to this WAF.  Only use this variable for regular rules.  Use the "rate\_based\_rules" variable for rate-based rules. | `list(string)` | `[]` | no |
| wafregional\_rule\_f5\_id | The ID of the F5 Rule Group to use for the WAF for the ALB.  Find the id with "aws waf-regional list-subscribed-rule-groups". | `string` | `""` | no |
| web\_acl\_metric\_name | Metric name of the Web ACL | `string` | n/a | yes |
| web\_acl\_name | Name of the Web ACL | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| waf\_acl\_id | WAF ACL ID generated by the module |


### Testing

[Terratest](https://github.com/gruntwork-io/terratest) is used for automated testing of this module. Tests in the `test` folder can be run
locally by running the following command:

```shell
make test
```

Or with aws-vault:

```shell
AWS_VAULT_KEYCHAIN_NAME=<NAME> aws-vault exec <PROFILE> -- make test
```
